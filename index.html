<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>R-Race: Precision</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: #fff; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #ui { position: absolute; top: 20px; font-size: 24px; color: #00ffcc; text-shadow: 0 0 10px #00ffcc; }
        canvas { background: #111; border: 4px solid #333; border-radius: 10px; max-width: 95vw; }
        .controls { display: flex; gap: 30px; margin-top: 20px; }
        .btn { width: 80px; height: 80px; background: #222; border: 2px solid #00ffcc; color: #00ffcc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; user-select: none; }
        .btn:active { background: #00ffcc; color: #000; }
    </style>
</head>
<body>

<div id="ui">SCORE: <span id="score">0</span></div>
<canvas id="raceCanvas"></canvas>

<div class="controls">
    <div class="btn" onpointerdown="move('L')">◀</div>
    <div class="btn" onpointerdown="move('R')">▶</div>
</div>

<script>
const canvas = document.getElementById('raceCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');

canvas.width = 300; canvas.height = 500;

// Yo'laklar koordinatalari
const lanes = [50, 150, 250]; 
let currentLane = 1; // Markaziy yo'lak
let gameActive = true, score = 0, speed = 5, musicStarted = false;

const car = { x: lanes[currentLane], y: 420, targetX: lanes[currentLane], w: 40, h: 70 };
let enemies = [], roadLines = [];

// Musiqa
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playMusic() {
    if (musicStarted) return; musicStarted = true;
    setInterval(() => {
        if(!gameActive) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        const freqs = [110, 130, 146, 164];
        osc.frequency.value = freqs[Math.floor(Date.now()/500)%4];
        gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.4);
    }, 500);
}

function move(dir) {
    playMusic();
    if(dir === 'L' && currentLane > 0) currentLane--;
    if(dir === 'R' && currentLane < 2) currentLane++;
    car.targetX = lanes[currentLane];
}

function spawnEnemy() {
    if(Math.random() < 0.02 + (speed/1000)) {
        const lane = Math.floor(Math.random() * 3);
        // Agar bu yo'lakda yaqin orada mashina bo'lmasa, yangisini qo'shish
        if(!enemies.some(e => e.lane === lane && e.y < 100)) {
            enemies.push({ x: lanes[lane], y: -100, lane: lane, color: '#ff3131' });
        }
    }
}

function update() {
    if(!gameActive) return;

    // Silliq harakat (Interpolation)
    car.x += (car.targetX - car.x) * 0.2;

    speed += 0.001;
    score += 1;
    scoreEl.innerText = Math.floor(score/10);

    // Yo'l chiziqlari
    if(Math.random() > 0.9) roadLines.push({y: -50});
    roadLines.forEach((l, i) => {
        l.y += speed;
        if(l.y > 600) roadLines.splice(i, 1);
    });

    enemies.forEach((e, i) => {
        e.y += speed;
        
        // Aniq to'qnashuv
        if(Math.abs(car.x - e.x) < 35 && Math.abs(car.y - e.y) < 65) {
            gameActive = false;
            alert("GAME OVER! Score: " + Math.floor(score/10));
            location.reload();
        }
        if(e.y > 600) enemies.splice(i, 1);
    });
}

function draw() {
    ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Yo'lak chiziqlari (Asfalt)
    ctx.strokeStyle = '#333'; ctx.setLineDash([20, 20]);
    ctx.beginPath(); ctx.moveTo(100, 0); ctx.lineTo(100, 500); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(200, 0); ctx.lineTo(200, 500); ctx.stroke();

    // Harakatlanuvchi yo'l chiziqlari
    ctx.strokeStyle = '#555'; ctx.setLineDash([]);
    roadLines.forEach(l => {
        ctx.strokeRect(100, l.y, 1, 30); ctx.strokeRect(200, l.y, 1, 30);
    });

    // O'yinchi mashinasi
    ctx.shadowBlur = 15; ctx.shadowColor = '#00f3ff';
    ctx.fillStyle = '#00f3ff';
    ctx.beginPath(); ctx.roundRect(car.x - 20, car.y, car.w, car.h, 5); ctx.fill();

    // Dushmanlar
    ctx.shadowColor = '#ff3131';
    enemies.forEach(e => {
        ctx.fillStyle = e.color;
        ctx.beginPath(); ctx.roundRect(e.x - 20, e.y, 40, 70, 5); ctx.fill();
    });

    ctx.shadowBlur = 0;
    update();
    spawnEnemy();
    requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>